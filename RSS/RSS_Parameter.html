<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">نمایشگر اخبار RSS پویا</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700&display=swap" rel="stylesheet">
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f0f2f5; direction: rtl; text-align: right; margin: 0; padding: 20px; color: #333; line-height: 1.6; }
        .container { max-width: 960px; margin: 0 auto; padding: 0 15px; }
        .header { text-align: center; color: #2c3e50; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 4px solid #4a90e2; font-weight: 700; font-size: 2.2em; }
        .news-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        .news-item { background-color: #ffffff; border-radius: 12px; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease; overflow: hidden; display: flex; flex-direction: column; }
        .news-item:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); }
        .news-item a { text-decoration: none; color: inherit; display: flex; flex-direction: column; height: 100%; }
        .news-image-container { width: 100%; height: 200px; overflow: hidden; border-top-left-radius: 12px; border-top-right-radius: 12px; }
        .news-image { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
        .news-item:hover .news-image { transform: scale(1.05); }
        .news-content { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .news-title { font-size: 1.35em; color: #1a73e8; margin-top: 0; margin-bottom: 12px; font-weight: 700; line-height: 1.4; }
        .news-pubdate { font-size: 0.85em; color: #888; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 8px; margin-top: auto; }
        .news-description { font-size: 0.95em; color: #555; margin-top: 0; margin-bottom: 15px; }
        .loading-message { text-align: center; font-size: 1.2em; color: #666; padding: 50px; grid-column: 1 / -1; }
        .error-message { text-align: center; font-size: 1.2em; color: #d9534f; padding: 50px; grid-column: 1 / -1; }
        @media (max-width: 768px) {
            .news-grid { grid-template-columns: 1fr; }
            .header { font-size: 1.8em; }
            .news-image-container { height: 180px; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="header" id="main-header">در حال استخراج آدرس RSS...</h1>
        <div id="rss-feed" class="news-grid">
            <p class="loading-message">در حال بارگذاری اخبار...</p>
        </div>
    </div>
    
    <script>
        // *******************************************
        // !!! نکته مهم: این آدرس را با Web App URL خود که از Google Apps Script گرفتید، جایگزین کنید.
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzJ53z2bmAv-9bqjv8JKzo0y1HhLU8QPuXL02w1uRd_al3Xz0Dyx0jDeF7QOyW3bYw5/exec';
        // *******************************************

        // تابع اصلی فراخوانی RSS از طریق سرویس واسط rss2json.com
        function loadRssFeed(rssUrl, sheetDetails) {
            const proxyUrl = 'https://api.rss2json.com/v1/api.json?rss_url=' + encodeURIComponent(rssUrl);

            $.ajax({
                url: proxyUrl,
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    $('#rss-feed').empty(); 
                    if (data.status === 'ok' && data.items.length > 0) {
                        
                        const title = data.feed.title || `اخبار دریافتی برای ${sheetDetails}`;
                        $('#main-header').text(title);
                        $('#page-title').text(title);
                        
                        data.items.forEach(function(item) {
                            let imageUrl = '';
                            if (item.enclosure && item.enclosure.link) { 
                                imageUrl = item.enclosure.link; 
                            } else {
                                const content = item.content || item.description;
                                const imgMatch = content.match(/<img[^>]+src="([^"]+)"/i);
                                if (imgMatch && imgMatch[1]) { 
                                    imageUrl = imgMatch[1]; 
                                }
                            }
                            
                            const cleanDescription = item.description ? item.description.replace(/(<([^>]+)>)/gi, "").trim() : '';

                            const newsHtml = `
                                <div class="news-item">
                                    <a href="${item.link}" target="_blank">
                                        ${imageUrl ? `<div class="news-image-container"><img src="${imageUrl}" class="news-image" alt="${item.title}"></div>` : ''}
                                        <div class="news-content">
                                            <h2 class="news-title">${item.title}</h2>
                                            <p class="news-description">${cleanDescription}</p>
                                            <p class="news-pubdate">تاریخ انتشار: ${new Date(item.pubDate).toLocaleDateString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                        </div>
                                    </a>
                                </div>
                            `;
                            $('#rss-feed').append(newsHtml);
                        });
                    } else {
                        $('#rss-feed').html('<p class="error-message">⚠️ متاسفانه، اطلاعاتی از فید خبری دریافت نشد یا فید خالی است.</p>');
                        $('#main-header').text(`خطا: فید خالی یا نامعتبر (${sheetDetails})`);
                    }
                },
                error: function(xhr, status, error) {
                    $('#rss-feed').html('<p class="error-message">❌ خطا در برقراری ارتباط با سرویس واسط RSS (rss2json.com). لطفاً مطمئن شوید آدرس RSS استخراج شده صحیح است.</p>');
                    $('#main-header').text(`خطا در دریافت اخبار (${sheetDetails})`);
                }
            });
        }

        // تابع اصلی برای اتصال به Google Script و شروع کار
        $(document).ready(function() {
            if (GOOGLE_SCRIPT_URL === 'YOUR_WEB_APP_URL_HERE') {
                $('#rss-feed').html('<p class="error-message">❌ آدرس GOOGLE_SCRIPT_URL تنظیم نشده است. لطفاً آن را در کد جاوا اسکریپت جایگزین کنید.</p>');
                $('#main-header').text('خطای تنظیمات');
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const cellId = urlParams.get('id'); // مثلا P12

            if (!cellId) {
                $('#rss-feed').html('<p class="error-message">❌ لطفاً پارامتر id (مثلاً P12) را در آدرس وارد کنید. مثال: <code>?id=P12</code></p>');
                $('#main-header').text('خطا: ورودی نامعتبر');
                return;
            }

            // --- مرحله ۱: اتصال به Web App برای دریافت آدرس RSS ---
            $('#main-header').text(`در حال استخراج آدرس RSS از شیت برای ${cellId}...`);
            
            $.ajax({
                url: GOOGLE_SCRIPT_URL + '?id=' + cellId,
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.status === 'ok' && response.rssUrl) {
                        // --- مرحله ۲: فراخوانی RSS با آدرس استخراج شده ---
                        loadRssFeed(response.rssUrl, cellId);
                    } else {
                        $('#rss-feed').html(`<p class="error-message">❌ خطا از سمت Google Sheet: ${response.message || 'آدرس RSS پیدا نشد یا نامعتبر است.'}</p>`);
                        $('#main-header').text(`خطا در شیت (${cellId})`);
                    }
                },
                error: function(xhr, status, error) {
                    $('#rss-feed').html('<p class="error-message">❌ خطا در اتصال به Google Apps Script. (بررسی Web App URL و وضعیت دیپلوی)</p>');
                    $('#main-header').text('خطا در اتصال به API');
                }
            });
        });
    </script>

</body>
</html>

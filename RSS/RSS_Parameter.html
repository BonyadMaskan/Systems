<script>
    $(document).ready(function() {
        
        const urlParams = new URLSearchParams(window.location.search);
        
        const baseUrl = urlParams.get('base');
        const queryText = urlParams.get('query');
        const hasKw = urlParams.get('kw'); // بررسی می کنیم که آیا باید از ?kw= استفاده کنیم یا خیر

        let rssUrl = null;

        if (baseUrl && queryText && hasKw) {
            // ترکیب آدرس: base + ?kw= + عبارت جستجو (که URLSearchParams به صورت خودکار کدگذاری کرده است)
            // نکته: مرورگر به صورت خودکار "آرش لهوني" را به %D8%A2%D8%B1%D8%B4%20%D9%84%D9%87%D9%88%D9%86%D9%8A تبدیل می کند.
            rssUrl = baseUrl + "?kw=" + queryText;
        } else if (baseUrl) {
             // اگر فقط base وجود دارد، فرض می کنیم یک آدرس RSS ساده است.
             rssUrl = baseUrl;
        }


        if (!rssUrl || !rssUrl.startsWith('http')) {
            $('#rss-feed').html('<p class="error-message">❌ لطفاً آدرس RSS معتبر را وارد کنید. مثال: `?base=https://mehrnews.com/rss&query=آرش لهوني&kw=1`</p>');
            $('#main-header').text('خطا: آدرس RSS معتبر نیست.');
            return;
        }

        // آدرس نهایی واسط RSS-to-JSON
        // نیازی به decodeURIComponent نیست، زیرا URLSearchParams و مرورگر کار را انجام داده‌اند.
        const proxyUrl = 'https://api.rss2json.com/v1/api.json?rss_url=' + encodeURIComponent(rssUrl);

        $('#main-header').text('در حال بارگذاری اخبار...');

        $.ajax({
            url: proxyUrl,
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                $('#rss-feed').empty(); 

                if (data.status === 'ok' && data.items.length > 0) {
                    
                    if (data.feed.title) {
                        $('#main-header').text(data.feed.title);
                    } else {
                        $('#main-header').text('جدیدترین اخبار');
                    }

                    data.items.forEach(function(item) {
                        let imageUrl = '';
                        if (item.enclosure && item.enclosure.link) {
                            imageUrl = item.enclosure.link;
                        } else {
                            const content = item.content || item.description;
                            const imgMatch = content.match(/<img[^>]+src="([^"]+)"/i);
                            if (imgMatch && imgMatch[1]) {
                                imageUrl = imgMatch[1];
                            }
                        }
                        
                        const cleanDescription = item.description ? item.description.replace(/(<([^>]+)>)/gi, "").trim() : '';

                        const newsHtml = `
                            <div class="news-item">
                                <a href="${item.link}" target="_blank">
                                    ${imageUrl ? `<div class="news-image-container"><img src="${imageUrl}" class="news-image" alt="${item.title}"></div>` : ''}
                                    <div class="news-content">
                                        <h2 class="news-title">${item.title}</h2>
                                        <p class="news-description">${cleanDescription}</p>
                                        <p class="news-pubdate">تاریخ انتشار: ${new Date(item.pubDate).toLocaleDateString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                    </div>
                                </a>
                            </div>
                        `;
                        $('#rss-feed').append(newsHtml);
                    });
                } else {
                    $('#rss-feed').html('<p class="error-message">⚠️ متاسفانه، اطلاعاتی از فید خبری دریافت نشد یا فید خالی است.</p>');
                    $('#main-header').text('خطا: فید خالی است');
                }
            },
            error: function(xhr, status, error) {
                $('#rss-feed').html('<p class="error-message">❌ خطا در برقراری ارتباط با سرویس واسط. لطفاً آدرس RSS و پارامترها را بررسی کنید.</p>');
                $('#main-header').text('خطا در دریافت اخبار');
            }
        });
    });
</script>
